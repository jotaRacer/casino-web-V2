<!DOCTYPE html>
<html>

<head>
    <title>Test Login Debug</title>
    <style>
        body {
            font-family: Arial;
            padding: 20px;
        }

        .success {
            color: green;
        }

        .error {
            color: red;
        }

        pre {
            background: #f4f4f4;
            padding: 10px;
        }
    </style>
</head>

<body>
    <h1>Login Debug Test</h1>

    <form id="testForm">
        <input type="email" id="email" value="caro1@mail.com" placeholder="Email"><br><br>
        <input type="password" id="password" value="123456" placeholder="Password"><br><br>
        <button type="submit">Test Login</button>
    </form>

    <h2>Console Output:</h2>
    <pre id="console"></pre>

    <h2>Result:</h2>
    <div id="result"></div>

    <script src="/js/auth-utils.js"></script>
    <script>
        const consoleDiv = document.getElementById('console');
        const resultDiv = document.getElementById('result');

        function log(msg) {
            console.log(msg);
            consoleDiv.textContent += msg + '\n';
        }

        log('✓ Page loaded');
        log('✓ auth-utils.js loaded: ' + (typeof saveToken !== 'undefined'));

        document.getElementById('testForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            log('\n--- Form submitted ---');

            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            log('Email: ' + email);
            log('Password: ' + password);

            try {
                log('Sending POST to /api/auth/login...');

                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ email, password })
                });

                log('Response status: ' + response.status);

                const data = await response.json();
                log('Response data: ' + JSON.stringify(data, null, 2));

                if (response.ok) {
                    log('✓ Login successful!');
                    log('Token: ' + data.token.substring(0, 50) + '...');

                    // Test saveToken
                    log('Calling saveToken()...');
                    saveToken(data.token);
                    log('✓ Token saved to localStorage');

                    // Verify token was saved
                    const savedToken = localStorage.getItem('casino_auth_token');
                    log('Verified token in localStorage: ' + (savedToken ? 'YES' : 'NO'));

                    resultDiv.innerHTML = '<p class="success">✓ Login successful! Token saved.</p>';

                    log('Would redirect to /perfil in 2 seconds...');
                    setTimeout(() => {
                        log('Redirecting now...');
                        window.location.href = '/perfil';
                    }, 2000);
                } else {
                    log('✗ Login failed: ' + data.message);
                    resultDiv.innerHTML = '<p class="error">✗ Login failed: ' + data.message + '</p>';
                }
            } catch (error) {
                log('✗ ERROR: ' + error.message);
                log('Stack: ' + error.stack);
                resultDiv.innerHTML = '<p class="error">✗ Error: ' + error.message + '</p>';
            }
        });

        log('✓ Event listener attached');
    </script>
</body>

</html>