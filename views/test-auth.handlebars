<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Login - Casino</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #121212;
            color: #E0E0E0;
            padding: 40px;
            max-width: 800px;
            margin: 0 auto;
        }

        h1 {
            color: #C9A227;
            text-align: center;
        }

        .test-section {
            background: #1e1e1e;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 2px solid #C9A227;
        }

        .test-section h2 {
            color: #C9A227;
            margin-top: 0;
        }

        button {
            background: #B71C1C;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }

        button:hover {
            background: #D32F2F;
        }

        .result {
            background: #0a0a0a;
            padding: 15px;
            border-radius: 6px;
            margin-top: 10px;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .success {
            color: #4caf50;
        }

        .error {
            color: #f44336;
        }

        .info {
            color: #2196f3;
        }

        a {
            color: #C9A227;
            text-decoration: none;
        }

        a:hover {
            text-decoration: underline;
        }
    </style>
</head>

<body>
    <h1>üß™ Test de Autenticaci√≥n</h1>

    <div class="test-section">
        <h2>1. Estado Actual</h2>
        <button onclick="checkAuthStatus()">Verificar Estado de Autenticaci√≥n</button>
        <button onclick="viewToken()">Ver Token Guardado</button>
        <button onclick="clearToken()">Limpiar Token</button>
        <div id="status-result" class="result"></div>
    </div>

    <div class="test-section">
        <h2>2. Test de Registro</h2>
        <p>Registrar usuario de prueba: <strong>test@casino.com</strong></p>
        <button onclick="testRegister()">Registrar Usuario de Prueba</button>
        <div id="register-result" class="result"></div>
    </div>

    <div class="test-section">
        <h2>3. Test de Login</h2>
        <p>Login con: <strong>test@casino.com / password123</strong></p>
        <button onclick="testLogin()">Hacer Login</button>
        <div id="login-result" class="result"></div>
    </div>

    <div class="test-section">
        <h2>4. Test de Endpoint Protegido</h2>
        <p>Probar acceso a /api/users/profile (requiere autenticaci√≥n)</p>
        <button onclick="testProtectedEndpoint()">Obtener Perfil</button>
        <div id="profile-result" class="result"></div>
    </div>

    <div class="test-section">
        <h2>5. Navegaci√≥n</h2>
        <p>Ir a las p√°ginas reales:</p>
        <a href="/register" target="_blank"><button>Ir a Registro</button></a>
        <a href="/login" target="_blank"><button>Ir a Login</button></a>
        <a href="/perfil" target="_blank"><button>Ir a Perfil</button></a>
        <a href="/roulette" target="_blank"><button>Ir a Ruleta</button></a>
    </div>

    <script src="/js/auth-utils.js"></script>
    <script>
        function log(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            const timestamp = new Date().toLocaleTimeString();
            element.innerHTML = `[${timestamp}] ${message}`;
            element.className = `result ${type}`;
        }

        function checkAuthStatus() {
            const isAuth = isAuthenticated();
            const token = getToken();
            if (isAuth) {
                log('status-result', `‚úÖ Usuario AUTENTICADO\nToken existe: ${token ? 'S√≠' : 'No'}`, 'success');
            } else {
                log('status-result', '‚ùå Usuario NO autenticado\nNo hay token en localStorage', 'error');
            }
        }

        function viewToken() {
            const token = getToken();
            if (token) {
                log('status-result', `Token JWT:\n${token}\n\nLongitud: ${token.length} caracteres`, 'info');
            } else {
                log('status-result', 'No hay token guardado', 'error');
            }
        }

        function clearToken() {
            removeToken();
            log('status-result', 'üóëÔ∏è Token eliminado de localStorage', 'success');
        }

        async function testRegister() {
            log('register-result', '‚è≥ Registrando usuario...', 'info');

            try {
                const response = await fetch('/api/auth/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        firstName: 'Test',
                        lastName: 'User',
                        email: 'test@casino.com',
                        password: 'password123',
                        dob: '1990-01-01'
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    log('register-result',
                        `‚úÖ REGISTRO EXITOSO\n\n${JSON.stringify(data, null, 2)}`,
                        'success'
                    );
                } else {
                    log('register-result',
                        `‚ö†Ô∏è Error en registro:\n${data.message}\n\n${JSON.stringify(data, null, 2)}`,
                        'error'
                    );
                }
            } catch (error) {
                log('register-result', `‚ùå Error de conexi√≥n:\n${error.message}`, 'error');
            }
        }

        async function testLogin() {
            log('login-result', '‚è≥ Iniciando sesi√≥n...', 'info');

            try {
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: 'test@casino.com',
                        password: 'password123'
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    // Guardar token
                    saveToken(data.token);

                    log('login-result',
                        `‚úÖ LOGIN EXITOSO\n\nToken guardado en localStorage\n\nRespuesta:\n${JSON.stringify(data, null, 2)}`,
                        'success'
                    );
                } else {
                    log('login-result',
                        `‚ö†Ô∏è Error en login:\n${data.message}\n\n${JSON.stringify(data, null, 2)}`,
                        'error'
                    );
                }
            } catch (error) {
                log('login-result', `‚ùå Error de conexi√≥n:\n${error.message}`, 'error');
            }
        }

        async function testProtectedEndpoint() {
            log('profile-result', '‚è≥ Obteniendo perfil...', 'info');

            const token = getToken();
            if (!token) {
                log('profile-result', '‚ùå No hay token. Debes hacer login primero.', 'error');
                return;
            }

            try {
                const response = await fetch('/api/users/profile', {
                    method: 'GET',
                    headers: getAuthHeaders()
                });

                const data = await response.json();

                if (response.ok) {
                    log('profile-result',
                        `‚úÖ PERFIL OBTENIDO\n\n${JSON.stringify(data, null, 2)}`,
                        'success'
                    );
                } else {
                    log('profile-result',
                        `‚ö†Ô∏è Error al obtener perfil:\n${data.message}\n\nStatus: ${response.status}`,
                        'error'
                    );
                }
            } catch (error) {
                log('profile-result', `‚ùå Error de conexi√≥n:\n${error.message}`, 'error');
            }
        }

        // Verificar estado al cargar
        window.addEventListener('load', () => {
            checkAuthStatus();
        });
    </script>
</body>

</html>